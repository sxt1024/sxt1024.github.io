<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.sxt1024.fun","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1.8 自己编写磁盘镜像工具 软件列表winimage 1 磁盘镜像格式 Dsk格式映像  Dsk格式是通用通用磁盘映像，一般做硬盘映像使用，打开dsk格式文件可以使用WinImage等软件，加载和修改可以使用Imdisk命令，使用Grub4Dos还可以直接挂载dsk格式映像为虚拟硬盘启动。另外，Apple II模拟器及一些电脑游戏映像一般也倾向使用这个格式。  Img格式映像  IMG是比较常见">
<meta property="og:type" content="article">
<meta property="og:title" content="寒冰小站">
<meta property="og:url" content="https://blog.sxt1024.fun/2024/10/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%99%84_%E7%BC%96%E5%86%99%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%B7%A5%E5%85%B7/index.html">
<meta property="og:site_name" content="寒冰小站">
<meta property="og:description" content="1.8 自己编写磁盘镜像工具 软件列表winimage 1 磁盘镜像格式 Dsk格式映像  Dsk格式是通用通用磁盘映像，一般做硬盘映像使用，打开dsk格式文件可以使用WinImage等软件，加载和修改可以使用Imdisk命令，使用Grub4Dos还可以直接挂载dsk格式映像为虚拟硬盘启动。另外，Apple II模拟器及一些电脑游戏映像一般也倾向使用这个格式。  Img格式映像  IMG是比较常见">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-10-26T17:08:17.073Z">
<meta property="article:modified_time" content="2018-08-19T07:43:54.000Z">
<meta property="article:author" content="sxt1024">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.sxt1024.fun/2024/10/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%99%84_%E7%BC%96%E5%86%99%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%B7%A5%E5%85%B7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.sxt1024.fun/2024/10/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%99%84_%E7%BC%96%E5%86%99%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%B7%A5%E5%85%B7/","path":"2024/10/27/操作系统/附_编写磁盘镜像工具/","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title> | 寒冰小站</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="寒冰小站" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">寒冰小站</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">1</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">1</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">53</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E5%88%97%E8%A1%A8"><span class="nav-number">1.</span> <span class="nav-text">软件列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">1 磁盘镜像格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-go%E8%AF%AD%E8%A8%80%E7%BC%96%E5%86%99%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%B7%A5%E5%85%B7"><span class="nav-number">3.</span> <span class="nav-text">2 go语言编写磁盘镜像工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99makefile"><span class="nav-number">4.</span> <span class="nav-text">编写makefile</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sxt1024</p>
  <div class="site-description" itemprop="description">寒冰的狂暴区</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.sxt1024.fun/2024/10/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%99%84_%E7%BC%96%E5%86%99%E7%A3%81%E7%9B%98%E9%95%9C%E5%83%8F%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sxt1024">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="寒冰小站">
      <meta itemprop="description" content="寒冰的狂暴区">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 寒冰小站">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-27 01:08:17" itemprop="dateCreated datePublished" datetime="2024-10-27T01:08:17+08:00">2024-10-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-08-19 15:43:54" itemprop="dateModified" datetime="2018-08-19T15:43:54+08:00">2018-08-19</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>1.8 自己编写磁盘镜像工具</p>
<h2 id="软件列表"><a href="#软件列表" class="headerlink" title="软件列表"></a>软件列表</h2><p>winimage</p>
<h2 id="1-磁盘镜像格式"><a href="#1-磁盘镜像格式" class="headerlink" title="1 磁盘镜像格式"></a>1 磁盘镜像格式</h2><ul>
<li>Dsk格式映像</li>
</ul>
<p>Dsk格式是通用通用磁盘映像，一般做硬盘映像使用，打开dsk格式文件可以使用WinImage等软件，加载和修改可以使用Imdisk命令，使用Grub4Dos还可以直接挂载dsk格式映像为虚拟硬盘启动。另外，Apple II模拟器及一些电脑游戏映像一般也倾向使用这个格式。</p>
<ul>
<li>Img格式映像</li>
</ul>
<p>IMG是比较常见的映像格式，如果是CD或DVD光盘映像，格式与ISO完全相同，可以直接改扩展名为ISO使用，如果是作为软盘或硬盘映像使用时，打开和编辑可以使用UltraISO、WinImage，使用可以借助daemon或Alcohol 120%加载。</p>
<ul>
<li>Ima格式映像</li>
</ul>
<p>IMA也是一种映像格式，本来只是用于软盘映像，IMA格式文件只是把磁盘内容简单的DUMP出来，包含内容与IMG格式相同，打开和编辑可以使用UltraISO、WinImage，使用上也被微软虚拟机所支持，也可以借助daemon或Alcohol 120%加载。</p>
<ul>
<li>Vhd格式映像</li>
</ul>
<p>VHD全称Virtual Hard Disks，虚拟磁盘的意思，可以同时支持在Windows平台和Linux平台使用，最初由Connectix创建，后来被微软虚拟机采纳使用， 完全采用软件模拟真实磁盘的柱面、扇区和磁头关系，虚拟机也大都使用这个格式，Disk2vhd、Winmount等都是很常用的加载或转换工具。</p>
<p>1)磁盘镜像格式<br>我们首先用winimage建立一个1.44M的软盘镜像os.img，然后引入引导文件boot.bin。使用二进制方式打开os.img和boot.bin。可以发现磁盘镜像格式如下：</p>
<ul>
<li><p>os.img除了开始的一段位置外，其他的都是数据0</p>
</li>
<li><p>通过比较os.img和boot.bin，发现os.img的开始位置就是boot.bin。也就是说os.img的最开始的512个字节就是引导扇区的内容。</p>
</li>
</ul>
<p>2）创建磁盘镜像</p>
<p>windows下可以使用用dos的命令： fsutil file createnew Rats.ima 1474560 创建一个1.44M的镜像</p>
<p>windows下可以使用winimage工具创建一个1.44M的镜像</p>
<p>使用qemu命令创建：qemu-img create - -o size&#x3D;1440k Rats.ima</p>
<h2 id="2-go语言编写磁盘镜像工具"><a href="#2-go语言编写磁盘镜像工具" class="headerlink" title="2 go语言编写磁盘镜像工具"></a>2 go语言编写磁盘镜像工具</h2><p>或许你会觉得用上面的工具来创建镜像有点复杂,不够happy.因此我们就自己定制一个镜像工具好了.</p>
<p>首先你要了解生成的镜像文件的结构,其实是一个.iso文件,文件最开始的位置为512kb的引导文件,其它位置存储的都是0.</p>
<p>接下来，我使用go写了一个磁盘镜像工具(当然啦,用其它什么语言都能实现,看你的心情)，创建镜像并引入引导文件。</p>
<p>定义命令格式如下：</p>
<blockquote>
<p>makeima os.img -size&#x3D;1474560 -b&#x3D;boot.bin</p>
</blockquote>
<p>参数说明：<br>1）size参数：文件大小。可使用k,M后缀<br>2）-b设置引导扇区文件</p>
<p>go语言代码</p>
<pre><code>package main

import (
    &quot;flag&quot;
    &quot;fmt&quot;
    &quot;os&quot;
    &quot;strconv&quot;
    &quot;strings&quot;
)

/*
 * 参数格式 makeima -size=1440k -b=boot.bin os.img
 */
func main() &#123;

    size_flag := flag.String(&quot;size&quot;, &quot;1440k&quot;, &quot;文件大小&quot;)
    bootname_flag := flag.String(&quot;b&quot;, &quot;&quot;, &quot;引导文件名&quot;)
    flag.Parse()


    //解析镜像文件名
    if len(flag.Args()) &lt; 1 &#123;
        fmt.Println(&quot;请输入镜像文件名&quot;)
        fmt.println(`参数格式 makeima -size=1440k -b=boot.bin os.img`)
        return
    &#125;

    //需要parse之后再获取值
    size := *size_flag
    bootname := *bootname_flag

    //解析size
    size_t := 0
    realSize := 1
    if len(size) &gt; 0 &#123;
        unit := size[len(size)-1]
        switch unit &#123;
        case &#39;k&#39;:
            size = strings.TrimRight(size, &quot;k&quot;)
            realSize = 1024
        case &#39;K&#39;:
            size = strings.TrimRight(size, &quot;K&quot;)
            realSize = 1024
        case &#39;m&#39;:
            size = strings.TrimRight(size, &quot;m&quot;)
            realSize = 1024 * 1000
        case &#39;M&#39;:
            size = strings.TrimRight(size, &quot;M&quot;)
            realSize = 1024 * 1000
        &#125;

    &#125;
    size_t, err := strconv.Atoi(size)
    if err != nil &#123;
        fmt.Println(&quot;错误的镜像大小格式&quot;, err)
        return
    &#125;
    realSize *= size_t

    //解析引导文件
    hasboot := true
    bc := make([]byte, 512)
    if bootname != &quot;&quot; &#123;
        fi, err := os.Open(bootname)
        if err != nil &#123;
            fmt.Println(&quot;引导文件读取错误:&quot;, bootname, err)
            return
        &#125;
        fi.Read(bc)
        if len(bc) != 512 &#123;
            fmt.Println(&quot;引导文件大小错误&quot;)
            return
        &#125;

    &#125; else &#123;
        hasboot = false
    &#125;


    imaname := flag.Args()[0]
    if imaname == &quot;&quot; &#123;
        fmt.Println(&quot;请输入镜像文件名&quot;)
    &#125;
    fi, err := os.Create(imaname)
    if err != nil &#123;
        fmt.Println(&quot;磁盘映像创建错误:&quot;, imaname, err)
        return
    &#125;
    //创建镜像文件
    fmt.Println(&quot;正在创建磁盘镜像......&quot;)
    if hasboot &#123;
        fi.Write(bc)
        fi.Write(make([]byte, realSize-512))
        fmt.Println(&quot;正在写入引导文件...&quot;)
    &#125; else &#123;
        fi.Write(make([]byte, realSize))
    &#125;
    fmt.Printf(&quot;创建磁盘镜像完成,大小为%d字节\n&quot;, realSize)
    fi.Close()
&#125;
</code></pre>
<p>好了，通过makeima Rats.img -b&#x3D;boot.bin	我们可以创建一个1.44M的带引导扇区的软盘镜像。至于往写入文件，我们就直接使用winimage的命令行操作了：<br>winimage.exe Rats.IMA  &#x2F;I loader.sys &#x2F;h</p>
<h2 id="编写makefile"><a href="#编写makefile" class="headerlink" title="编写makefile"></a>编写makefile</h2><p>下面创建一个makefile文件，将所有的编译，连接，创建镜像，添加文件，运行虚拟器等等，进行一键执行。<br>代码如下：</p>
<pre><code># 配置
export path=$path;D:\MinGW\bin;
boot = boot
nasm = tools/nasm.exe
gcc = D:/mingw/bin/gcc.exe
obj2bim = tools/obj2bim.exe
bim2hrb = tools/bim2hrb.exe
winima = winima90/winimage.exe
mkima = tools/mkima.exe

build: Rats.IMA
##copy Rats.IMA ..\Qemu-windows-1.0.1  /y
    ..\Qemu-windows-1.0.1\qemu-system-i386.exe -fda Rats.ima

Rats.IMA:boot.bin loader.sys
    $(mkima) -b=boot.bin Rats.IMA
    $(winima) Rats.IMA  /I loader.sys /h

loader.sys :  boot.bin loader0.bin loader.hrb
#确保PATH环境下没有sh.exe
    copy /B loader0.bin+loader.hrb loader.sys

# 构建bin
%.bin: $(boot)/%.asm
    $(nasm) -f bin -o $*.bin $(boot)/$*.asm

# 构建hrb
loader.hrb : loader.bim
    $(bim2hrb) loader.bim loader.hrb 0

# 构建bim
loader.bim : loader.obj loaderfunc.obj
    $(obj2bim) @haribote/haribote.rul out:loader.bim stack:3136k map:loader.map \
        loader.obj loaderfunc.obj

# 构建obj
loader.obj: $(boot)/loader.c
    $(gcc)  -c  $(boot)/loader.c -o loader.obj

loaderfunc.obj:$(boot)/loaderfunc.asm
    $(nasm) -f win32 -o loaderfunc.obj $(boot)/loaderfunc.asm

# clean
clean:
    -del *.bin
    -del *.bim
    -del *.map
    -del *.lst
    -del *.gas
    -del *.obj
    -del *.sys
    -del loader.hrb
</code></pre>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/10/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%99%84_fat32%E4%B8%BB%E5%BC%95%E5%AF%BC%E6%89%87%E5%8C%BA%E6%A0%BC%E5%BC%8F/" rel="prev" title="">
                  <i class="fa fa-angle-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/10/27/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E9%99%84_%E8%A7%A3%E6%9E%90ELF%E6%96%87%E4%BB%B6/" rel="next" title="">
                   <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">sxt1024</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
