# fat32启动扇区

## 格式如下


偏移（字节）	| 长度（字节）|	说明
-----|-----|------
0x00	|3|	跳转指令（跳过开头一段区域）
0x03	|8|	OEM名称（空格补齐）。MS-DOS检查这个区域以确定使用启动记录中的哪一部分数据 [1] 。常见值是IBM 3.3（在“IBM”和“3.3”之间有两个空格）和MSDOS5.0.
0x0b	|2|	每个扇区的字节数。基本输入输出系统参数块从这里开始。
0x0d	|1|	每簇扇区数
0x0e	|2|	保留扇区数（包括启动扇区）
0x10	|1|	文件分配表数目
0x11	|2|	最大根目录条目个数
0x13	|2|	总扇区数（如果是0，就使用偏移0x20处的4字节值）
0x15	|1|	介质描述
0x16	|2|	每个文件分配表的扇区（FAT16）
0x18	|2|	每磁道的扇区
0x1a	|2|	磁头数
0x1c	|4|	隐藏扇区
0x20	|4|	总扇区数（如果超过65535，参见偏移0x13）
0x24	|4|	每个文件分配表的扇区（FAT32）。扩展基本输入输出系统参数块从这里开始。
0x24	|1|	物理驱动器个数（FAT16）
0x25	|1|	当前磁头（FAT16）
0x26	|1|	签名（FAT16）
0x27	|4|	ID（FAT16）
0x28	|2|	Flags（FAT32）
0x2a   |2|	版本号（FAT32）
0x2c    |4|	根目录启始簇（FAT32）
0x2b	|11|	卷标（非FAT32）
0x30	|2|	FSInfo扇区（FAT32）
0x32	|2|	引导扇区备份（FAT32）
0x34	|12|	保留未使用（FAT32）
0x36	|8|	FAT文件系统类型（如FAT、FAT12、FAT16）
0x3e	|2|	操作系统自引导代码
0x40	|1|	BIOS设备代号（FAT32）
0x41	|1|	未使用（FAT32）
0x42   |1| 标记（FAT32）
0x43	|4|	卷序号（FAT32）
0x47	|11|	卷标（FAT32）
0x52	|8|	FAT文件系统类型（FAT32）
0x1FE	|2|	扇区结束符（0x55 0xAA）


介质描述

    0xF8 	单面、每面80磁道、每磁道9扇区
    0xF9	双面、每面80磁道、每磁道9扇区
    0xFA	单面、每面80磁道、每磁道8扇区
    0xFB	双面、每面80磁道、每磁道8扇区
    0xFC	单面、每面40磁道、每磁道9扇区
    0xFD	双面、每面40磁道、每磁道9扇区
    0xFE	单面、每面40磁道、每磁道8扇区
    0xFF	双面、每面40磁道、每磁道8扇区
    0xFF	双面、每面40磁道、每磁道8扇区
同样的介质描述必须在重复复制到每份FAT的第一个字节。有些操作系统（MSX-DOS 1.0版）全部忽略启动扇区参数，而仅仅使用FAT的第一个字节的介质描述确定文件系统参数。

## 汇编代码

现在流行拿来主义。我们直接使用FAT32文件系统的引导扇区格式。

FAT32 ： http://zh.wikipedia.org/wiki/FAT32#FAT32

在boot目录建立一个boot.asm的文件。使用汇编写出如下代码：

汇编代码如下：

    ;icy os
    ;TAB=4
    [BITs 16]
        ORG     0x7c00 			;指明程序的偏移的基地址

    ;以下这段是标准FAT12   格式软盘专用的代码   
    	JMP     Entry
    	DB      0x90
    	DB      "ICYBOOT "      ;   启动区的名称可以是任意的字符串（8字节）    
    	DW      512             ;   每个扇区（sector）的大小（必须为512  字节）
    	DB      1               ;   簇（cluster   ）的大小（必须为1个扇区）   
    	DW      1               ;   FAT的起始位置（一般从第一个扇区开始）    
    	DB      2               ;   FAT的个数（必须为2）    
    	DW      224             ;   根目录的大小（一般设成224  项）  
    	DW      2880            ;   该磁盘的大小（必须是2880扇区）   
    	DB      0xf0            ;   磁盘的种类（必须是0xf0）  
    	DW      9               ;   FAT的长度（必须是9扇区）  
    	DW      18              ;   1个磁道（track  ）有几个扇区（必须是18）   
    	DW      2               ;   磁头数（必须是2）   
    	DD      0               ;   不使用分区，必须是0  
    	DD      2880            ;   重写一次磁盘大小    
    	DB      0,0,0x29        ;   意义不明，固定
    	DD      0xffffffff      ;   序列号
    	DB      "ICY_OS     "   ;   磁盘的名称（必须11字节）   
    	DB      "FAT12   "   	;   磁盘格式名称（必须8字节）
    	RESB    18              ;   先空出18字节

    ;程序核心内容
    Entry:
        JMP Fin

    ;程序挂起
    Fin:
        HLT                     ;让CPU挂起，等待指令。
        JMP Fin

    FillSector:
        RESB    510-($-$$)       ; 处理当前行$至结束(1FE)的填充
        DB      0x55, 0xaa



## 例如fat32的引导扇区

    ;以下这段是标准FAT32 格式软盘专用的代码
    		JMP     Entry
    		DB      0x90                ;nop,0x02
    		DB      "RATSBOOT"          ;（8字节）启动区的名称可以是任意的字符串
    		DW      512                 ;每个扇区（sector）的大小（必须为512 字节）
    		DB      8                   ;簇（cluster ）的大小（每个簇为8个扇区）
    		DW      584                 ;保留扇区数,包括启动扇区
    		DB      2                   ;FAT的个数（必须为2）
    		DW      0                   ;最大根目录条目个数
    		DW      0                   ;总扇区数（如果是0，就使用偏移0x20处的4字节值）
    		DB      0x00f8              ;磁盘介质描述
    		DW      0                   ;（FAT16）每个文件分配表的扇区
    		DW      63                  ;每个磁道扇区数
    		dw      255                 ;磁头数
    		dd      63                  ;隐藏扇区
    		dd      3902913             ;磁盘大小，总共扇区数（如果超过65535，参见偏移0x13）
    		dd      3804                ;每个文件分配表的扇区，3804个扇区

    		dw      0                   ;Flagss
    		dw      0                   ;版本号
    		dd      2                   ;根目录启始簇

    		dw      1                   ;FSInfo扇区
    		dw      6                   ;启动扇区备份
    		times 12 db 0               ;保留未使用

    		DW      0                   ;操作系统自引导代码
    		db      0x80                ;BIOS设备代号
    		db      0                   ;未使用
    		db      0x29                ;标记
    		DD      0xffffffff          ;序列号
    		DB      "HELLO-OS   "       ;(11字节)磁盘名称，卷标。字符串长度固定
    		DB      "FAT32   "          ;(8字节)FAT文件系统类型。 0x52

    		times 12 db 0
