---
title: chap2.5_内存规划
date: 2019-01-14T11:27:28
lastmod: 2019-01-14
timezone: UTC+8
tags:
  - 操作系统
categories:
  - 操作系统
draft: false
---





# 加载器

## 引导的第三阶段

1. 第一次加载文件，引导扇区，系统的入口
2. 第二次加载文件，loader文件，负责从16位实模式进入32位保护模式
3. 第三次加载文件，进入C语言实现，运行在32位系统下。



按照正常的逻辑，BIOS载入执行引导扇区后，主引导记录就应该去查询并执行内核文件了。

但是存在着下面几个问题：

1. 没有文件系统，就算磁盘有内核的内容，引导代码也不知道应该从哪里加载内核内容执行。

2. 主引导记录只有512KB，没有办法做更多的操作

因此需要二阶段的引导，流程如下：

主引导记录继续加载执行一段第二阶段引导程序，而这段内容可能占据几个扇区。

第二阶引导程序会构建文件系统，然后根据文件系统查找和执行内核。


第二阶引导程序我们称之为loader。加载器。

## 读取加载器

磁盘的1扇区为mbr扇区 ，我们规定其后面2-6扇区为loader内容的扇区。流程如下：

BIOS加载执行引导扇区。

引导扇区访问磁盘，并读取磁盘的2-6扇区。


复制磁盘的2-6扇区到内存的0x90000位置，并执行。

### 1. loader文件的位置

1）内存分配

在boot引导完成后，当前系统的内存分配如下：

内存 0x7c00-0x7dff ：引导扇区

内存 0x8000-N      : 读取的磁盘内容 ( 其中的 0xc200-0xc3ff 是loader文件)

2）loader在内存的位置

在前面的引导程序里面已经将磁盘的10个柱面加载到了内存单元的0x8000处。而在ima文件中程序的起始位置（也就是引导扇区）在磁盘中的位置是 0x4200。

同样在内存也是从 0x8000 往后的 0x4200 位置。

所以loader的内容在内存单元的开始位置为：0x8000+0x4200=0xc200位置。

说明：

整个磁盘文件包括引导扇区512+磁盘文件sys。loader在sys文件的0x4200位置，引导扇区在此之后。

因此磁盘文件复制到内存0x8000处，所以得出loader的位置需要0x8000+0x4200所以得出0xc200这个位置。

但是其实0x4200之前是没什么用的。因此将磁盘引导区原本在磁盘的位置靠后现在给提前了，复制到了8000-81ff的位置，单独放了一块。

这个和真实磁盘文件放置不同（前后问题），慢慢理解。



loader1.asm

```
;RatsOS
;TAB=4

%include "boot/boot.inc"

[bits 32]

    org 0x9800

    jmp Entry

;程序核心内容
Entry:
	;显存段地址
	mov byte [gs:0x00],'h'      ;输出字符
	mov byte [gs:0x01],0x17     ;设置颜色(背景色蓝，前景色白)
	mov byte [gs:0x02],'e'
	mov byte [gs:0x03],0x17
	mov byte [gs:0x04],'l'
	mov byte [gs:0x05],0x17
	mov byte [gs:0x06],'l'
	mov byte [gs:0x07],0x17
	mov byte [gs:0x08],'o'
	mov byte [gs:0x09],0x17
	mov byte [gs:0x0a],','
	mov byte [gs:0x0b],0x17
	mov byte [gs:0x0c],'l'
	mov byte [gs:0x0d],0x17
	mov byte [gs:0x0e],'o'
	mov byte [gs:0x0f],0x17
	mov byte [gs:0x10],'a'
	mov byte [gs:0x11],0x17
	mov byte [gs:0x12],'d'
	mov byte [gs:0x13],0x17
	mov byte [gs:0x14],'e'
	mov byte [gs:0x15],0x17
	mov byte [gs:0x16],'r'
	mov byte [gs:0x17],0x17
	mov byte [gs:0x18],'1'
	mov byte [gs:0x19],0x17


	jmp $                     	;让CPU挂起，等待指令。

```



## 内存分配

磁盘分布图

| 磁盘区域                    | 数据内容   | 说明     |
| --------------------------- | ---------- | -------- |
| 0x0000 - 0x0200 （1个扇区） | boot.bin   | 引导扇区 |
| 0x0200 - 0x0A00（4个扇区）  | loader.bin |          |
| 0x0A00 - 0x1400（25个扇区） | head.bin   |          |
|                             |            |          |

**实模式内存分布图**

| 内存区域            | 大小   | 数据内容        | 说明                   |
| ------------------- | ------ | --------------- | ---------------------- |
| 0x0000 - 0x03FF     | 1K     |                 | 中断向量表             |
| 0x0400 - 0x04FF     | 256B   |                 | BIOS数据区             |
| 0x7C00 - 0x7DFF     | 512B   | boot.bin        | 引导扇区的内存地址     |
| 0x9200 - 0x99FF     | 2048B  | loader.bin      |                        |
| 0x9A00 - 0xc200     | 10240B | loader1.bin     |                        |
|                     |        |                 |                        |
| 0x70000 - 0x709FF   |        | loader1.bin映像 |                        |
| 0x90000 - 0x92FFF |        | 系统参数信息表 |                        |
| 0x9FC00 - 0x9FFFF   | 1K     |                 | 扩展BISO数据区域       |
| 0xB8000 - 0xB8FFFF  |        |                 | 显存地址(默认)         |
| 0xA00000 - 0xAFFFFF |        |                 | 显存地址64KB(图形模式) |



* 一般来说，0x00000-0x9FFFF(576KB)这段物理地址空间是提供给内存的。
* 而 0xA0000-0xEFFFF 这段物理地址空间(320KB)则是留给外围设备的，包括显卡(显卡占用0xB8000-0xC7FFF)。
* 而 0xB0000-0xBFFFF 这段物理地址空间(64KB)则是由主板的ROM-BIOS芯片提供。



**保护模式**

| 内存区域            | 大小   | 数据内容        | 说明                   |
| ------------------| ------ | --------------- | ---------------------- |
| 0x1000 - 0x17FF     | 2048B  | 系统信息 |        |
| 0x9000 - 0x97FF     | 2048B  | loader.bin      | loader内存位置       |
| 0x9800 - 0xBFFF     | 10KB  | kernel.bin      | kernel内存位置       |
|    ...              |  ...  |      ...   |    ...  |
| 0xB8000 - 0xB8FFFF  |        |                 | 显存地址(默认)         |



## 分页模式
| 内存区域            | 大小   | 数据内容        | 说明                   |
| ------------------| ------ | --------------- | ---------------------- |
| 0x0000 - 0xffff    |  |       | loader内存位置       |
| 0xffff  - 0xBFFF     |  | GDT表      | kernel内存位置       |





**## GDT信息**



| GDT           | 段类型   | 基本地址        | 限制                   | 属性|
| -------------------| ------ | --------------- | ---------------------- |------ |
| GDT[0x00]    | Data segment|base=0x00000000  | limit=0xffffffff     | Read/Write |
| GDT[0x01]    | Code segment|base=0x00280000  | limit=0x0007ffff   |  Execute/Read |


系统参数信息表

|内存地址| 字节偏移量  | 说明 |  |  |
|---	|---		|---	|---|---|
|0x90000| 2|内存ards个数|---|
|0x92000| 2|内存ards个数|---|
|0x92002| 200|ards表|---|





